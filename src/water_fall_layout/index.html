<!DOCTYPE html>
<!-- saved from url=(0060)http://www.zhangxinxu.com/study/201203/waterfall-layout.html -->
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <title>瀑布流布局测试</title>
    <style>
        body {
            background-color: #eee;
            font-size: 84%;
            text-align: justify;
        }

        .column {
            display: inline-block;
            vertical-align: top;
        }

        .pic_a {
            display: block;
            padding: 5px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            background-color: #fff;
            text-decoration: none;
        }

        .pic_a img {
            display: block;
            margin: 0 auto 5px;
            border: 0;
            vertical-align: bottom;
        }

        .pic_a strong {
            color: #333;
        }
    </style>
    <style id="style-1-cropbar-clipper">/* Copyright 2014 Evernote Corporation. All rights reserved. */
    .en-markup-crop-options {
        top: 18px !important;
        left: 50% !important;
        margin-left: -100px !important;
        width: 200px !important;
        border: 2px rgba(255, 255, 255, .38) solid !important;
        border-radius: 4px !important;
    }

    .en-markup-crop-options div div:first-of-type {
        margin-left: 0px !important;
    }
    </style>
</head>

<body>
<div id="container"><span id="waterFallColumn_0" class="column" style="width:210px;"><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_000.jpg"><strong>000</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_007.jpg"><strong>007</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_014.jpg"><strong>014</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_021.jpg"><strong>021</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_028.jpg"><strong>028</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_043.jpg"><strong>043</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_049.jpg"><strong>049</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_055.jpg"><strong>055</strong></a></span> <span id="waterFallColumn_1" class="column"
                                                                       style="width:210px;"><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_001.jpg"><strong>001</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_008.jpg"><strong>008</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_015.jpg"><strong>015</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_022.jpg"><strong>022</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_029.jpg"><strong>029</strong></a></span> <span id="waterFallColumn_2" class="column"
                                                                       style="width:210px;"><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_002.jpg"><strong>002</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_009.jpg"><strong>009</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_016.jpg"><strong>016</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_023.jpg"><strong>023</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_030.jpg"><strong>030</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_036.jpg"><strong>036</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_039.jpg"><strong>039</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_044.jpg"><strong>044</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_050.jpg"><strong>050</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_056.jpg"><strong>056</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_061.jpg"><strong>061</strong></a></span> <span id="waterFallColumn_3" class="column"
                                                                       style="width:210px;"><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_003.jpg"><strong>003</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_010.jpg"><strong>010</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_017.jpg"><strong>017</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_024.jpg"><strong>024</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_031.jpg"><strong>031</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_035.jpg"><strong>035</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_037.jpg"><strong>037</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_040.jpg"><strong>040</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_045.jpg"><strong>045</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_051.jpg"><strong>051</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_057.jpg"><strong>057</strong></a></span> <span id="waterFallColumn_4" class="column"
                                                                       style="width:210px;"><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_004.jpg"><strong>004</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_011.jpg"><strong>011</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_018.jpg"><strong>018</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_025.jpg"><strong>025</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_032.jpg"><strong>032</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_046.jpg"><strong>046</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_052.jpg"><strong>052</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_058.jpg"><strong>058</strong></a></span> <span id="waterFallColumn_5" class="column"
                                                                       style="width:210px;"><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_005.jpg"><strong>005</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_012.jpg"><strong>012</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_019.jpg"><strong>019</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_026.jpg"><strong>026</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_033.jpg"><strong>033</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_041.jpg"><strong>041</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_047.jpg"><strong>047</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_053.jpg"><strong>053</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_059.jpg"><strong>059</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_062.jpg"><strong>062</strong></a></span> <span id="waterFallColumn_6" class="column"
                                                                       style="width:210px;"><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_006.jpg"><strong>006</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_013.jpg"><strong>013</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_020.jpg"><strong>020</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_027.jpg"><strong>027</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_034.jpg"><strong>034</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_038.jpg"><strong>038</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_042.jpg"><strong>042</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_048.jpg"><strong>048</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_054.jpg"><strong>054</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_060.jpg"><strong>060</strong></a><a
        href="http://www.zhangxinxu.com/study/201203/waterfall-layout.html###" class="pic_a"><img
        src="./images/P_063.jpg"><strong>063</strong></a></span> <span id="waterFallDetect" class="column"
                                                                       style="width:210px;"></span></div>
<script>
    var waterFall = {
        container: document.getElementById("container"),
        columnNumber: 1,
        columnWidth: 210,
        // P_001.jpg ~ P_160.jpg
        rootImage: "http://cued.xunlei.com/demos/publ/img/",
        indexImage: 0,

        scrollTop: document.documentElement.scrollTop || document.body.scrollTop,
        detectLeft: 0,

        loadFinish: false,

        // 返回固定格式的图片名
        getIndex: function () {
            var index = this.indexImage;
            if (index < 10) {
                index = "00" + index;
            } else if (index < 100) {
                index = "0" + index;
            }
            return index;
        },

        // 是否滚动载入的检测
        appendDetect: function () {
            var start = 0;
            for (start; start < this.columnNumber; start++) {
                var eleColumn = document.getElementById("waterFallColumn_" + start);
                if (eleColumn && !this.loadFinish) {
                    if (eleColumn.offsetTop + eleColumn.clientHeight < this.scrollTop + (window.innerHeight || document.documentElement.clientHeight)) {
                        this.append(eleColumn);
                    }
                }
            }

            return this;
        },

        // 滚动载入
        append: function (column) {
            this.indexImage += 1;
            var html = '', index = this.getIndex(), imgUrl = this.rootImage + "P_" + index + ".jpg";

            // 图片尺寸
            var aEle = document.createElement("a");
            aEle.href = "###";
            aEle.className = "pic_a";
            aEle.innerHTML = '<img src="' + imgUrl + '" /><strong>' + index + '</strong>';
            column.appendChild(aEle);

            if (index >= 160) {
                //alert("图片加载光光了！");
                this.loadFinish = true;
            }

            return this;
        },

        // 页面加载初始创建
        create: function () {
            this.columnNumber = Math.floor(document.body.clientWidth / this.columnWidth);

            var start = 0, htmlColumn = '', self = this;
            for (start; start < this.columnNumber; start += 1) {
                htmlColumn = htmlColumn + '<span id="waterFallColumn_' + start + '" class="column" style="width:' + this.columnWidth + 'px;">' +
                        function () {
                            var html = '', i = 0;
                            for (i = 0; i < 5; i += 1) {
                                self.indexImage = start + self.columnNumber * i;
                                var index = self.getIndex();
                                html = html + '<a href="###" class="pic_a"><img src="' + self.rootImage + "P_" + index + '.jpg" /><strong>' + index + '</strong></a>';
                            }
                            return html;
                        }() +
                        '</span> ';
            }
            htmlColumn += '<span id="waterFallDetect" class="column" style="width:' + this.columnWidth + 'px;"></span>';

            this.container.innerHTML = htmlColumn;

            this.detectLeft = document.getElementById("waterFallDetect").offsetLeft;
            return this;
        },

        refresh: function () {
            var arrHtml = [], arrTemp = [], htmlAll = '', start = 0, maxLength = 0;
            for (start; start < this.columnNumber; start += 1) {
                var arrColumn = document.getElementById("waterFallColumn_" + start).innerHTML.match(/<a(?:.|\n|\r|\s)*?a>/gi);
                if (arrColumn) {
                    maxLength = Math.max(maxLength, arrColumn.length);
                    // arrTemp是一个二维数组
                    arrTemp.push(arrColumn);
                }
            }

            // 需要重新排序
            var lengthStart, arrStart;
            for (lengthStart = 0; lengthStart < maxLength; lengthStart++) {
                for (arrStart = 0; arrStart < this.columnNumber; arrStart++) {
                    if (arrTemp[arrStart][lengthStart]) {
                        arrHtml.push(arrTemp[arrStart][lengthStart]);
                    }
                }
            }


            if (arrHtml && arrHtml.length !== 0) {
                // 新栏个数
                this.columnNumber = Math.floor(document.body.clientWidth / this.columnWidth);

                // 计算每列的行数
                // 向下取整
                var line = Math.floor(arrHtml.length / this.columnNumber);

                // 重新组装HTML
                var newStart = 0, htmlColumn = '', self = this;
                for (newStart; newStart < this.columnNumber; newStart += 1) {
                    htmlColumn = htmlColumn + '<span id="waterFallColumn_' + newStart + '" class="column" style="width:' + this.columnWidth + 'px;">' +
                            function () {
                                var html = '', i = 0;
                                for (i = 0; i < line; i += 1) {
                                    html += arrHtml[newStart + self.columnNumber * i];
                                }
                                // 是否补足余数
                                html = html + (arrHtml[newStart + self.columnNumber * line] || '');

                                return html;
                            }() +
                            '</span> ';
                }
                htmlColumn += '<span id="waterFallDetect" class="column" style="width:' + this.columnWidth + 'px;"></span>';

                this.container.innerHTML = htmlColumn;

                this.detectLeft = document.getElementById("waterFallDetect").offsetLeft;

                // 检测
                this.appendDetect();
            }
            return this;
        },

        // 滚动加载
        scroll: function () {
            var self = this;
            window.onscroll = function () {
                // 为提高性能，滚动前后距离大于100像素再处理
                var scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
                if (!this.loadFinish && Math.abs(scrollTop - self.scrollTop) > 100) {
                    self.scrollTop = scrollTop;
                    self.appendDetect();
                }

            };
            return this;
        },

        // 浏览器窗口大小变换
        resize: function () {
            var self = this;
            window.onresize = function () {
                var eleDetect = document.getElementById("waterFallDetect"), detectLeft = eleDetect && eleDetect.offsetLeft;
                if (detectLeft && Math.abs(detectLeft - self.detectLeft) > 50) {
                    // 检测标签偏移异常，认为布局要改变
                    self.refresh();
                }
            };
            return this;
        },
        init: function () {
            if (this.container) {
                this.create().scroll().resize();
            }
        }
    };
    waterFall.init();
</script>


</body>
</html>